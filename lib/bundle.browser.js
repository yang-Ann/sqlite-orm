!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@anlib/sqlite-orm"]={})}(this,(function(e){"use strict";class t{opt;#e;#t;constructor(e){this.opt=e,this.#e=e.tableName,this.#t=e.isFillValue}curOrmStore=this.getDefaultCurOrmStore();getDefaultCurOrmStore(){return{insert:void 0,delete:void 0,update:void 0,select:void 0,count:void 0,groupBy:void 0,where:void 0,limit:void 0,fillValue:[]}}get $tableName(){return this.opt.tableName}get $isFillValue(){return this.opt.isFillValue}setTableName(e){return this.opt.tableName=e,this.#e=e,this}setFillValue(e){return this.opt.isFillValue=e,this.#t=e,this}clearCurOrmStore(){return this.curOrmStore=this.getDefaultCurOrmStore(),this.opt.isFillValue=this.#t,this.opt.tableName=this.#e,this}setOperStore(e,t){return this.curOrmStore={...this.curOrmStore,select:void 0,delete:void 0,update:void 0,count:void 0,[e]:t},this.curOrmStore.curOper=e,this}tableName(e){return this.opt.tableName=e,this}fillValue(e=!0){return this.opt.isFillValue=e,this}inser(e){const[t,r]=this.buildInsertValues([e]);return this.clearCurOrmStore(),[`INSERT or REPLACE INTO "${this.$tableName}" ${t}`,r]}insers(e,t=999){if(0===e.length)return[];const r=Object.keys(e[0]),i=Math.floor(t/r.length);return this.dataSlice({datas:e,onceMaxDataLength:i}).map((e=>{const[t,r]=this.buildInsertValues(e);return this.clearCurOrmStore(),[`INSERT or REPLACE INTO "${this.$tableName}" ${t}`,r]}))}delete(){return this.setOperStore("delete",!0)}update(e){return this.setOperStore("update",e)}select(e="*"){return this.setOperStore("select",e)}count(e){return this.setOperStore("count",e.startsWith("count(")?`count(${e})`:e)}groupBy(e){return this.curOrmStore.groupBy=e,this}orderBy(e,t){return this.curOrmStore.orderBy=[e,t],this}buildWhereItem(e,t,r,i="PUSH"){const l=["IN","IS NOT","NOT","like"].includes(t)?` ${t} `:t;let s=r;if(r)if("string"==typeof r)this.$isFillValue?(s="?","PUSH"==i?this.curOrmStore.fillValue.push(r):this.curOrmStore.fillValue.unshift(r)):s=`"${r}"`;else if("IN"===t&&Array.isArray(r)){s=`(${r.map((e=>this.$isFillValue?("PUSH"==i?this.curOrmStore.fillValue.push(e):this.curOrmStore.fillValue.unshift(e),"?"):"string"==typeof e?`"${e}"`:e)).join(", ")})`}else this.$isFillValue?(s="?","PUSH"==i?this.curOrmStore.fillValue.push(r):this.curOrmStore.fillValue.unshift(r)):s=r;return`${e}${l}${s}`}where(e,t,r){const i={key:e,connect:t,value:r,type:"WHERE"};return this.curOrmStore.isSetWhere=!0,this.curOrmStore.where?this.curOrmStore.where.unshift(i):this.curOrmStore.where=[i],this}setWhere(e,t,r,i){const l={key:e,connect:t,value:r,type:"WHERE"},s={key:"",connect:"",value:i,type:"CONNECT"};if(this.curOrmStore.where){"("===this.curOrmStore.where[this.curOrmStore.where.length-1].value?this.curOrmStore.where.push(l):this.curOrmStore.where.push(s,l)}else this.where(e,t,r);return this}and(e,t,r){return this.setWhere(e,t,r,"AND")}or(e,t,r){return this.setWhere(e,t,r,"OR")}getConnectItem(e=""){return{key:"",connect:"",value:e,type:"CONNECT"}}buildWhereArrayItem(e,t,r,i){return r.length&&(this.curOrmStore.isSetWhere=!0),this.curOrmStore.where?this.curOrmStore.where.push(this.getConnectItem(i),this.getConnectItem("(")):this.curOrmStore.where=[this.getConnectItem("(")],r.forEach((r=>{"AND"===i?this.and(e,t,r):"OR"===i&&this.or(e,t,r)})),this.curOrmStore.where.push(this.getConnectItem(")")),this}whereArray(e,t,r,i){return r.length?this.buildWhereArrayItem(e,t,r,i):console.warn("空数组 WHERE 条件"),this}orArray(e,t,r){return r.length?this.buildWhereArrayItem(e,t,r,"OR"):console.warn("空数组 WHERE 条件"),this}andArray(e,t,r){return r.length?this.buildWhereArrayItem(e,t,r,"AND"):console.warn("空数组 WHERE 条件"),this}limit(e,t){return this.curOrmStore.limit=void 0===t?[e]:[e,t],this}getSqlRaw(){return this.buildRawSql()}buildWhere(){const e=this.curOrmStore.where;e&&!this.curOrmStore.isSetWhere&&e.shift();let t="";if(e&&e.length){t=`WHERE ${e.map((e=>"WHERE"!==e.type?"CONNECT"===e.type?e.value:(console.warn("未知的操作类型: ",e),""):e.connect?this.buildWhereItem(e.key,e.connect,e.value):void console.warn("连接符异常: ",e))).join(" ")}`}return t}buildGroupBy(){const e=this.curOrmStore.groupBy;let t="";return e&&(this.$isFillValue?(this.curOrmStore.fillValue.push(e),t="GROUP BY ?"):t=`GROUP BY ${e}`),t}buildOrderBy(){const e=this.curOrmStore.orderBy;let t="";if(e&&e.length){const[r,i]=e;this.$isFillValue?(this.curOrmStore.fillValue.push(r,i),t="ORDER BY ? ?"):t=`ORDER BY ${r} ${i}`}return t}buildLimit(){const e=this.curOrmStore.limit;let t="";if(e&&e.length){const[r,i]=e;this.$isFillValue?void 0===i?(this.curOrmStore.fillValue.push(r),t="LIMIT ?"):(this.curOrmStore.fillValue.push(r,i),t="LIMIT ?,?"):t=void 0===i?`LIMIT ${r}`:`LIMIT ${r},${i}`}return t}buildInsertValues(e){if(!e||0===e.length)return["",[]];const t=Object.keys(e[0]),r=`(${t.join(", ")}) VALUES`,i=[];e.forEach((e=>{const r=[];t.forEach((t=>{for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)&&t===i){const t=e[i];this.$isFillValue&&this.curOrmStore.fillValue.push(t),"string"==typeof t?r.push(this.$isFillValue?"?":`"${t}"`):r.push(this.$isFillValue?"?":t)}})),i.push(r)}));const l=i.map((e=>`(${e.join(", ")})`)).join(", ");if(this.$isFillValue){return[`${r} ${l}`,this.cloneData(this.curOrmStore.fillValue.flat())]}return[`${r} ${l}`,[]]}cloneData(e){return JSON.parse(JSON.stringify(e))}buildRawSql(){const e=this.curOrmStore.curOper;if(!e)throw new Error("没有指定操作类型, 至少需要调用delete, update, select, count 其中一个方法");let t="";t=`${{delete:"DELETE FROM",update:"UPDATE",select:`SELECT ${this.curOrmStore.select} FROM`,count:`SELECT count(${this.curOrmStore.count}) FROM`}[e]} "${this.$tableName}"`;const r=this.getOtherSql();if("delete"===e)t=`${t} ${r}`;else if("update"===e){const e=this.curOrmStore.update;if(e){const i=Object.keys(e),l=Object.values(e);let s;s=this.$isFillValue?i.map(((e,t)=>(this.curOrmStore.fillValue.unshift(l[t]),`${e}=?`))).join(", "):i.map(((e,t)=>`${e}="${l[t]}"`)).join(", "),t=`${t} SET ${s} ${r}`}}else"select"!==e&&"count"!==e||(t=`${t} ${r}`);if(t=t.replace(/\s+/g," ").trim(),this.$isFillValue){const e=this.cloneData(this.curOrmStore.fillValue.flat());return this.clearCurOrmStore(),[t,e]}return this.clearCurOrmStore(),[t,[]]}getOtherSql(){return`${this.buildWhere()} ${this.buildGroupBy()} ${this.buildOrderBy()} ${this.buildLimit()}`}addColumn(e,t,r=this.$tableName){return this.clearCurOrmStore(),this.$isFillValue,[`ALTER TABLE "${r}" ADD ${e} ${t};`,[]]}dataSlice(e){this.clearCurOrmStore();const t=e.onceMaxDataLength,r=JSON.parse(JSON.stringify(e.datas)),i=Math.ceil(r.length/t),l=[];for(let e=0;e<i;e++){const i=r.slice(e*t,(e+1)*t);l.push(i)}return l}buildUpdateByWhen(e){if(0===e.datas.length)return console.warn("数组数据为空"),[];const t=[],r=this.dataSlice({datas:e.datas,onceMaxDataLength:e.onceMaxUpdateDataLength||999});for(let i=0;i<r.length;i++){const l=this.$buildUpdateByWhen({datas:r[i],onceMaxUpdateDataLength:e.onceMaxUpdateDataLength,fieldOpts:e.fieldOpts,getExtraUpdateWhen:e.getExtraUpdateWhen,getExtraWhere:e.getExtraWhere});t.push(l)}return t}$buildUpdateByWhen(e){const t=[],r=[];e.fieldOpts.forEach((i=>{const{setField:l,getWhenField:s,getWhenValue:u,getThenValue:a}=i,h=`${l} = CASE ${e.datas.map((e=>{const t=s(e),i=u(e),l=a(e);return this.$isFillValue?(r.push(i,l),`WHEN ${t}=? THEN ?`):`WHEN ${t}="${i}" THEN "${l}"`})).join(" ")} END`;t.push(h)}));const i="SET "+t.join(", "),l=e.getExtraUpdateWhen?", "+e.getExtraUpdateWhen(e.datas):"",s=e.getExtraWhere?`WHERE ${e.getExtraWhere(e.datas)}`:"",u=`UPDATE "${this.$tableName}" ${i} ${l} ${s}`.trim();return this.$isFillValue?[u,r]:[u,[]]}tableInfo(e=this.$tableName){return new t({tableName:"sqlite_master",isFillValue:this.opt.isFillValue}).select().where("type","=","table").and("name","=",e).getSqlRaw()}findById(e,t="id"){return this.clearCurOrmStore().select().where(t,"=",e).getSqlRaw()}selectAll(e=this.$tableName){return this.clearCurOrmStore().tableName(e).select().getSqlRaw()}deleteById(e,t="id"){return this.clearCurOrmStore().delete().where(t,"=",e).getSqlRaw()}deleteAll(e=this.$tableName){return this.clearCurOrmStore().tableName(e).delete().where("1","=",1).getSqlRaw()}deleteTable(e=this.$tableName){return this.clearCurOrmStore(),this.$isFillValue?["DROP TABLE IF EXISTS ?",[e]]:[`DROP TABLE IF EXISTS "${e}"`,[]]}buildCreate(e,t=this.$tableName){this.clearCurOrmStore();const r=[];e.forEach((e=>{const{field:t,type:i,isKey:l,isNotNull:s}=e,u=`${t} ${i}${l?" PRIMARY KEY AUTOINCREMENT":""}${s?" NOT NULL":""}`;r.push(u)}));const i=`CREATE TABLE IF NOT EXISTS "${t}" (${r.join(", ")});`;return this.$isFillValue,[i,[]]}}e.SqliteOrm=t,e.VERSION="0.0.10",e.default=t,Object.defineProperty(e,"__esModule",{value:!0})}));
